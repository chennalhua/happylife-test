<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div style="width: 500px; height: 500px; padding: 20px; background-color: pink;" id="download">
        <img src="./S__1818637.jpg" style="width: 100%;" />
    </div>
    <button id="btn">click</button>
    <a href="" id="click" style="display: none;">下載</a>

    <script src="./html2canvas.js"></script>
    <script>
        window.onload = function () {
            var IMAGE_URL;
            function takeScreenshot() {
                var shareContent = document.getElementById('download');//需要截图的包裹的（原生的）DOM 对象
                var width = shareContent.offsetWidth; //获取dom 宽度
                var height = shareContent.offsetHeight; //获取dom 高度
                var canvas = document.createElement("canvas"); //创建一个canvas节点

                var scale = 2; //定义任意放大倍数 支持小数
                canvas.width = width * scale; //定义canvas 宽度 * 缩放
                canvas.height = height * scale; //定义canvas高度 *缩放
                canvas.getContext("2d") //获取context,设置scale

                // var rect = shareContent.getBoundingClientRect();//获取元素相对于视察的偏移量
                // canvas.getContext("2d").translate(-rect.left,-rect.top);//设置context位置，值为相对于视窗的偏移量负值，让图片复位
                var opts = {
                    dpi: 144,
                    scale: scale, // 添加的scale 参数
                    canvas: canvas, //自定义 canvas
                    logging: true, //日志开关
                    width: width, //dom 原始宽度
                    height: height, //dom 原始高度
                    backgroundColor: 'transparent',
                };
                html2canvas(shareContent, opts).then(function (canvas) {
                    IMAGE_URL = canvas.toDataURL("image/png");
                })
            }

            function dataURLtoBlob(dataurl) {
                var arr = dataurl.split(','),
                    mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]),
                    n = bstr.length,
                    u8arr = new Uint8Array(n)
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n)
                }
                return new Blob([u8arr], { type: mime })
            }
            function downloadBase64(dataUrl, filename) {
                var imageFile, href
                var downloadLink = document.querySelector('#click');
                // var downloadLink = document.getElementById('dl-hidden')
                try {
                    var blob = dataURLtoBlob(dataUrl)
                    var href = window.URL.createObjectURL(blob)
                    downloadLink.download = filename
                    downloadLink.href = href
                    downloadLink.click()
                } catch (err) {
                } finally {
                    if (href) {
                        window.URL.revokeObjectURL(href)
                    }
                    // downloadLink.remove()
                }
            }

            takeScreenshot();

            document.querySelector('#btn').addEventListener('click',function (e) {
                downloadBase64(IMAGE_URL, 'demo.png')
            })
        }
    </script>
</body>

</html>