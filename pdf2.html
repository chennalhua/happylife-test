<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- <meta http-equiv="Content-Security-Policy" content="script-src 'self' *.url.cn *.idqqimg.com *.qq.com *.gtimg.cn 'unsafe-inline' 'unsafe-eval';">      -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="Copyright" content="Tencent">
    <meta name="format-detection" content="telephone=no">
    <title>happylife-test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
    <link rel="stylesheet" href="./assets/css/all.css">
    <style>
        #letter{
            background-color: pink;
            width: 200px;
            height: 500px;
        }
    </style>
</head>

<body ontouchstart="">
    <div id="content">
        <img src="" class="copyImage" alt="">
        <div class="letter-content" id="letter">
            <p>2021/10/01</p>
        </div>
    </div>
    <button id="save-local">下載</button>
    <!-- <a id="dl-hidden" style="display:none;" download="合成图.png"
        href=""></a> -->

    <!-- <script src="./zepto.js"></script> -->
    <script src="./html2canvas.js"></script>
    <script>
        window.onload = function () {
            var IMAGE_URL;
            function takeScreenshot() {
                var shareContent = document.getElementById('letter');//需要截图的包裹的（原生的）DOM 对象
                var width = shareContent.offsetWidth; //获取dom 宽度
                var height = shareContent.offsetHeight; //获取dom 高度
                var canvas = document.createElement("canvas"); //创建一个canvas节点

                var scale = 1; //定义任意放大倍数 支持小数
                canvas.width = width * scale; //定义canvas 宽度 * 缩放
                canvas.height = height * scale; //定义canvas高度 *缩放
                canvas.getContext("2d") //获取context,设置scale

                // var rect = shareContent.getBoundingClientRect();//获取元素相对于视察的偏移量
                // canvas.getContext("2d").translate(-rect.left,-rect.top);//设置context位置，值为相对于视窗的偏移量负值，让图片复位
                var opts = {
                    scale: scale, // 添加的scale 参数
                    canvas: canvas, //自定义 canvas
                    logging: true, //日志开关
                    width: width, //dom 原始宽度
                    height: height, //dom 原始高度
                    backgroundColor: 'transparent',
                };
                html2canvas(shareContent, opts).then(function (canvas) {
                    IMAGE_URL = canvas.toDataURL("image/png");
                    // document.querySelector('.copyImage').setAttribute('src',IMAGE_URL);
                    downloadBase64(IMAGE_URL, '合成图.png')
                })
            }

            function dataURLtoBlob(dataurl) {
                var arr = dataurl.split(','),
                    mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]),
                    n = bstr.length,
                    u8arr = new Uint8Array(n)
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n)
                }
                return new Blob([u8arr], { type: mime })
            }

            function downloadBase64(dataUrl, filename) {
                var imageFile, href
                const downloadLink = document.createElement('a')
                // var downloadLink = document.getElementById('dl-hidden')
                try {
                    var blob = dataURLtoBlob(dataUrl)
                    var href = window.URL.createObjectURL(blob)
                    downloadLink.download = filename
                    downloadLink.href = href
                    downloadLink.click()
                } catch (err) {
                } finally {
                    if (href) {
                        window.URL.revokeObjectURL(href)
                    }
                    // downloadLink.remove()
                }
            }

            document.querySelector('#save-local').addEventListener('click',function(){
                takeScreenshot()
            })
            
        }
    </script>

</body>

</html>